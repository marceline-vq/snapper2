function AudioProcessor(a){function c(a){return{extract:function(c,e,f){for(var g=[],h=0;h<a.numberOfChannels;h++)g.push(a.getChannelData(h));for(h=0;h<e;h++)for(var m=0;m<g.length;m++)c[h*g.length+m%g.length]=g[m][h+f];return Math.min(e,g[0].length-f)}}}this.timeStretch=function(b,d){var e=new SoundTouch(b.sampleRate);e.tempo=d;for(var f=c(b),e=new SimpleFilter(f,e),f=a.createBuffer(b.numberOfChannels,1/d*b.length,b.sampleRate),g=[],h=0;h<b.numberOfChannels;h++)g.push(f.getChannelData(h));for(var m=
new Float32Array(2048),l=e.extract(m,1024),n=0;l;){for(h=0;h<l;h++)for(var t=0;t<g.length;t++)g[t][h+n]=m[h*g.length+t%g.length];n+=l;l=e.extract(m,1024)}return f}};function AudioProcessorSource(a,c,b){var d=this,e=new SoundTouch(c.sampleRate);this.stretchRatio={setValue:function(a){e.tempo=a},getValue:function(){return e.tempo}};this.playbackRate={setValue:function(a){e.rate=a},getValue:function(){return e.rate}};var f=new SimpleFilter({extract:function(a,b,d){for(var e=[],f=0;f<c.numberOfChannels;f++)e.push(c.getChannelData(f));for(f=0;f<b;f++)for(var g=0;g<e.length;g++)a[f*e.length+g%e.length]=e[g][f+d];return Math.min(b,e[0].length-d)}},e),g=a.createScriptProcessor(1024,
2,c.numberOfChannels),h=new Float32Array(2048);g.onaudioprocess=function(a){for(var b=[],e=0;e<c.numberOfChannels;e++)b.push(a.outputBuffer.getChannelData(e));a=f.extract(h,1024);0==a&&d.stop();for(e=0;e<a;e++)for(var g=0;g<b.length;g++)b[g][e]=h[e*b.length+g%b.length]};this.start=function(a){setTimeout(function(){g.connect(b)},a)};this.stop=function(){g.disconnect()}};function Scheduler(a,c,b){function d(){0<w&&w--;0==w&&c&&c(w)}function e(k){var b=k.getUri(),c;if(v[b])for(c=u[b],d=0;d<c.length;d++)f(b,c[d].getDymo().getUri(),c[d]);else{c=l(k);v[b]={};for(var d=0;d<c.length;d++){var w=c[d].getDymo();f(b,w.getUri(),c[d]);p[b]=w.getParameter(ONSET).getValue()}}var g;g=r[b]?r[b]-a.currentTime:.1;w=a.currentTime+g;for(d=0;d<c.length;d++)c[d].play(w);setTimeout(function(){for(var a=[],k=0;k<c.length;k++)a.push(c[k].getDymo());m(a)},g);(d=l(k))?(u[b]=d,d=d[0].getDymo().getParameter(ONSET).getValue(),
g=d-p[b],-1!=d?(r[b]=w+g,p[b]=d):r[b]=w+c[0].getDuration()/c[0].getDymo().getParameter(PLAYBACK_RATE).getValue(),r[b]&&(B=setTimeout(function(){e(k)},1E3*(r[b]-a.currentTime-.1)))):(r[b]=w+c[0].getDuration()/c[0].getDymo().getParameter(PLAYBACK_RATE).getValue(),B=setTimeout(function(){h(k)},1E3*(r[b]-a.currentTime)))}function f(a,k,b){v[a][k]=b}function g(a,k){var b=v[a.getUri()];if(b)for(var c in b)b[c][k].call(b[c])}function h(a){window.clearTimeout(B);var k=a.getUri();v[k]=null;u[k]=null;r[k]=
null;a.resetPartsPlayed();m([])}function m(a){for(var k=[],c=0;c<a.length;c++)for(var d=a[c];null!=d;)0>k.indexOf(d.getUri())&&k.push(d.getUri()),d=d.getParent();t.urisOfPlayingDymos=k;b&&b()}function l(b){if(b=b.getNextParts()){for(var c=[],d=0;d<b.length;d++)if(b[d].getSourcePath()){var e=q[b[d].getSourcePath()];c.push(new Source(b[d],a,e,k))}return c}}function n(k,b){w++;var c=new XMLHttpRequest;c.open("GET",k,!0);c.responseType="arraybuffer";c.onload=function(){a.decodeAudioData(c.response,function(a){b(a)})};
c.send()}var t=this,x="",q={},v={},u={},r={},p={};this.urisOfPlayingDymos=[];this.listenerOrientation=new Parameter(this,0);var k=a.createConvolver();k.connect(a.destination);var w=0,B;this.setReverbFile=function(a){n(a,function(a){k.buffer=a;d()})};this.setDymoBasePath=function(a){x=a};this.getDymoBasePath=function(){return x};this.addSourceFile=function(a){q[a]||n(x+a,function(k){q[a]=k;d()})};this.getBuffer=function(a){return q[a.getSourcePath()]};this.play=function(a){a.updatePartOrder(ONSET);
e(a)};this.pause=function(a){g(a,"pause")};this.stop=function(a){g(a,"stop");h(a)};this.getSources=function(a){return v[a.getUri()]};this.updateListenerOrientation=function(){var k=this.listenerOrientation.value/180*Math.PI;a.listener.setOrientation(Math.sin(k),0,-Math.cos(k),0,1,0)}};function Source(a,c,b,d){function e(){var k=a.getParameter(TIME_STRETCH_RATIO).getValue();if(1!=k){if(0!=A||y<b.duration)b=n(b,l(A,b),l(y+.3,b));b=(new AudioProcessor(c)).timeStretch(b,k);k=y/k;b=n(b,0,l(k+.02,b));y=k}else if(0!=A||y<b.duration)b=n(b,l(A,b),l(y+.02,b));t(b,b.length);z.buffer=b;p[PLAYBACK_RATE]=z.playbackRate;f(PLAYBACK_RATE,a.getParameter(PLAYBACK_RATE))}function f(a,k){h(a,k.getValue());k.addObserver(v)}function g(){for(var b=0;b<k.length;b++){var c=a.getParameter(k[b]);c&&c.removeObserver(v)}}
function h(a,k,b){b&&(k+=v.getParameterValue(a));0>k&&0<=w.indexOf(a)&&(k=0);b=k;p[a]&&(p[a].value||0==p[a].value?p[a].value=b:p[a].setValue(b));0<=B.indexOf(a)?(0==p[DISTANCE].value&&(p[DISTANCE].value=-.01),E.setPosition(p[PAN].value,p[HEIGHT].value,p[DISTANCE].value)):a==LOOP&&(z.loop=1==k)}function m(){u=!1;var a=c.currentTime;p[AMPLITUDE].setValueAtTime(p[AMPLITUDE].value,a);p[AMPLITUDE].linearRampToValueAtTime(0,a+.02);z.stop(a+.04)}function l(a,k){if(a||0==a)return Math.round(a*k.sampleRate)}
function n(a,k,b){b=Math.min(a.length-k,b);for(var d=c.createBuffer(a.numberOfChannels,b,a.sampleRate),e=0;e<a.numberOfChannels;e++)for(var w=d.getChannelData(e),f=a.getChannelData(e),g=0;g<b;g++)w[g]=f[k+g];return d}function t(a,k){for(var b=.02*a.sampleRate,c=0;c<a.numberOfChannels;c++)for(var d=a.getChannelData(c),e=0;e<b;e++)d[e]*=e/b,d[k-e-1]*=e/b}function x(a,k,b,c){q("http://localhost:8060/getAudioChunk?filename="+a+"&fromSecond="+k+"&toSecond="+b,function(a){c(a)})}function q(a,k){var b=new XMLHttpRequest;
b.open("GET",a,!0);b.responseType="arraybuffer";b.onload=function(){c.decodeAudioData(b.response,function(a){k(a)},function(a){throw Error(a);})};b.send()}var v=this,u,r,p={},k=[AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,REVERB,FILTER,PAN,HEIGHT,DISTANCE,LOOP],w=[AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,REVERB,FILTER],B=[PAN,HEIGHT,DISTANCE],z=c.createBufferSource(),C=c.createGain();C.connect(c.destination);var D=c.createGain();D.connect(d);D.gain.value=0;C.connect(D);var E=c.createPanner();E.connect(C);
d=c.createBiquadFilter();d.type="lowpass";d.frequency.value=2E4;d.connect(E);z.connect(d);var F=a.getSegment(),A=F[0],y=F[1];A||(A=0);y||(y=b.duration-A);b?e():x(a.getSourcePath(),A,A+y+.3,function(k){b=k;k=a.getParameter(TIME_STRETCH_RATIO).getValue();1!=k?(b=(new AudioProcessor(c)).timeStretch(b,k),k=y/k,b=n(b,0,l(k+.02,b)),y=k):b=n(b,0,l(y+.02,b));t(b,b.length);z.buffer=b});p[AMPLITUDE]=C.gain;p[TIME_STRETCH_RATIO]={value:0};p[REVERB]=D.gain;p[FILTER]=d.frequency;p[PAN]={value:0};p[HEIGHT]={value:0};
p[DISTANCE]={value:0};p[LOOP]={value:0};f(AMPLITUDE,a.getParameter(AMPLITUDE));f(TIME_STRETCH_RATIO,a.getParameter(TIME_STRETCH_RATIO));f(REVERB,a.getParameter(REVERB));f(PAN,a.getParameter(PAN));f(HEIGHT,a.getParameter(HEIGHT));f(DISTANCE,a.getParameter(DISTANCE));f(LOOP,a.getParameter(LOOP));this.observedParameterChanged=function(a){h(a.getName(),a.getChange(),!0)};this.getDymo=function(){return a};this.getDuration=function(){return y};this.isLoopingAndPlaying=function(){return z.loop&&u};this.getParameterValue=
function(a){if(p[a])return p[a].value||0==p[a].value?p[a].value:p[a].getValue()};this.play=function(a){z.onended=g;z.start(a);u=!0};this.pause=function(){u?(m(),r=!0):r&&(r=!1,this.play())};this.stop=function(){u&&(g(),m())}};function OntologyLoader2(a,c,b){};function DymoLoader(a,c,b){function d(k,b,c,f,g){var h=new XMLHttpRequest;h.addEventListener("load",function(){b=b?b.replace('"'+k+'"',this.responseText):this.responseText;var a=e(b);a?d(a,b,c,f,g):f(g(JSON.parse(b),c))});h.open("GET",a.getDymoBasePath()+k);h.send()}function e(a){var b=a.indexOf(".json");if(0<=b){if(b!=a.indexOf("context.json")+7){var c=a.substring(0,b).lastIndexOf('"');return a.substring(c+1,b+5)}return e(a.substring(b+1))}}function f(a,b){var c=g(a,b);h(a,b);return[c,b]}function g(k,
b){var c=new DynamicMusicObject(k["@id"],a,k.ct);b[k["@id"]]=c;c.setSourcePath(k.source);k.navigator&&c.setNavigator(q(k.navigator,c));for(var d in k)0>p.indexOf(d)&&(k[d].type==FEATURE?c.setFeature(d,k[d].value):k[d].type==PARAMETER&&t(c,d,k[d].value));if(k.parts)for(d=0;d<k.parts.length;d++)c.addPart(g(k.parts[d],b));return c}function h(a,b){var c=b[a["@id"]];if(a.similars)for(var d=0;d<a.similars.length;d++)c.addSimilar(b[a.similars[d]]);if(a.mappings)for(d=0;d<a.mappings.length;d++)c.addMapping(l(a.mappings[d],
b,c));if(a.parts)for(d=0;d<a.parts.length;d++)h(a.parts[d],b)}function m(a,b){for(var c=new Rendering(b[a.topDymo]),d={},e=0;e<a.mappings.length;e++)c.addMapping(l(a.mappings[e],b,void 0,d));return[c,d]}function l(a,b,c,d){if(a.controls){for(var e=[],f=0;f<a.controls.length;f++)e.push(d[a.controls[f]]);return n(a,b,c,e,d)}if(a.dymos){var e=[],g;if(a.dymos instanceof Array)for(f=0;f<a.dymos.length;f++)e.push(b[a.dymos[f]]);else g=Function.apply(null,a.dymos.args.concat(a.dymos.body)),f=Object.keys(b).map(function(a){return b[a]}),
Array.prototype.push.apply(e,f.filter(g));return n(a,b,c,e,d,g)}}function n(a,b,c,d,e,f){b=a.relative;for(var g=[],h=0;h<a.domainDims.length;h++){var l=a.domainDims[h].name,n=a.domainDims[h].type;n!=FEATURE&&(n==PARAMETER?l=c?t(c,l,0):new Parameter(l,0):e?(e[l]||(e[l]=v(n,l)),l=e[l]):l=v(n,l));g.push(l)}return new Mapping(g,b,a["function"],d,a.parameter,f)}function t(a,b,c){var d=a.getParameter(b);d?d.update(c):(d=new Parameter(b,c),a.addParameter(d));return d}function x(a,b){for(var c=0;c<a.length;c++)if(a[c])for(var d=
0;d<a[c].length;d++){var e=b["dymo"+c],f=b["dymo"+a[c][d]];e&&f&&e.addSimilar(f)}}function q(a,b){return a==SIMILARITY_NAVIGATOR?new SimilarityNavigator(b):new SequentialNavigator(b)}function v(a,b){if(a==ACCELEROMETER_X)return u(0);if(a==ACCELEROMETER_Y)return u(1);if(a==ACCELEROMETER_Z)return u(2);if(a==TILT_X)return u(3);if(a==TILT_Y)return u(4);if(a==GEOLOCATION_LATITUDE)return r(0);if(a==GEOLOCATION_LONGITUDE)return r(1);if(a==GEOLOCATION_DISTANCE)return r(2);if(a==COMPASS_HEADING){var d;c.compassWatcher||
(c.compassWatcher=new CompassWatcher);d=c.compassWatcher.headingControl;return d}if(a==SLIDER||a==TOGGLE||a==BUTTON)return new Control(b,a);if(a==RANDOM)return d=(new StatsControls).randomControl,d;if(a==BROWNIAN)return d=(new BrownianControls).brownianControl,d;if(a==RAMP)return d=(new RampControls).linearRampControl,d}function u(a){c.accelerometerWatcher||(c.accelerometerWatcher=new AccelerometerWatcher);if(0==a)return c.accelerometerWatcher.xControl;if(1==a)return c.accelerometerWatcher.yControl;
if(2==a)return c.accelerometerWatcher.zControl;if(3==a)return c.accelerometerWatcher.tiltXControl;if(4==a)return c.accelerometerWatcher.tiltYControl}function r(a){c.geolocationWatcher||(c.geolocationWatcher=new GeolocationWatcher);return 0==a?c.geolocationWatcher.latitudeControl:1==a?c.geolocationWatcher.longitudeControl:c.geolocationWatcher.distanceControl}var p="@id @type ct source navigator similars mappings parts".split(" ");this.loadDymoFromJson=function(b,c,e){a.setDymoBasePath(b);d(c,"",{},
e,f)};this.parseDymoFromJson=function(a,b){b(f(a,{}))};this.loadRenderingFromJson=function(a,b,c){d(a,"",b,c,m)};this.loadGraphFromJson=function(a,b,c){d(a,"",b,c,x)}};function DymoWriter(a){function c(a){a.addTriple("_:","http://www.w3.org/1999/02/22-rdf-syntax-ns#type","dmo:DMO");a.addTriple("_:","ch:hasPart","ch:test2")}function b(a,b){var c=new XMLHttpRequest;c.send(b);c.addEventListener("save",function(){console.log("saved "+a)});c.addEventListener("error",function(){console.log("saving "+a+" failed")});c.open("POST",a);c.send()}this.writeDymoToJson=function(a,c,f){a["@context"]="http://purl.org/ontology/dymo/context.json";f||(f="dymo.json");b(c+f,a)};this.writeRenderingToJson=
function(a,c){b(c+"rendering.json",a)};this.writeDmoToRdf=function(a){a=N3.Writer({prefixes:{ch:"rdf/charm.n3#",dmo:"rdf/dmo.n3#",mb:"rdf/mobile.n3#"}});c(a);a.end(function(a,b){console.log(b)})}};var DYMO="Dymo",PARALLEL="parallel",SEQUENTIAL="sequential",DYMO_TYPES=[PARALLEL,SEQUENTIAL],FEATURE="Feature",PARAMETER="Parameter",SEQUENTIAL_NAVIGATOR="SequentialNavigator",SIMILARITY_NAVIGATOR="SimilarityNavigator",PLAY="Play",LOOP="Loop",ONSET="Onset",DURATION_RATIO="DurationRatio",AMPLITUDE="Amplitude",PLAYBACK_RATE="PlaybackRate",TIME_STRETCH_RATIO="TimeStretchRatio",PAN="Pan",DISTANCE="Distance",HEIGHT="Height",REVERB="Reverb",FILTER="Filter",PART_INDEX="PartIndex",PART_COUNT="PartCount",
PART_ORDER="PartOrder",LISTENER_ORIENTATION="ListenerOrientation",STATS_FREQUENCY="StatsFrequency",BROWNIAN_FREQUENCY="BrownianFrequency",BROWNIAN_MAX_STEP_SIZE="BrownianMaxStepSize",RAMP_TRIGGER="RampTrigger",LEAPING_PROBABILITY="LeapingProbability",CONTINUE_AFTER_LEAPING="ContinueAfterLeaping",PARAMETERS=[PLAY,LOOP,ONSET,DURATION_RATIO,AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,PAN,DISTANCE,HEIGHT,REVERB,FILTER,PART_INDEX,PART_COUNT,PART_ORDER,LISTENER_ORIENTATION,STATS_FREQUENCY],LEVEL="level",
INDEX="index",ONSET_FEATURE="onset",PITCH_FEATURE="pitch",DURATION_FEATURE="duration",AUTO_CONTROL="AutoControl",SLIDER="Slider",TOGGLE="Toggle",BUTTON="Button",ACCELEROMETER_X="AccelerometerX",ACCELEROMETER_Y="AccelerometerY",ACCELEROMETER_Z="AccelerometerZ",TILT_X="TiltX",TILT_Y="TiltY",GEOLOCATION_LATITUDE="GeolocationLatitude",GEOLOCATION_LONGITUDE="GeolocationLongitude",GEOLOCATION_DISTANCE="GeolocationDistance",COMPASS_HEADING="CompassHeading",RANDOM="Random",BROWNIAN="Brownian",RAMP="Ramp",
CONTROLS=[SLIDER,TOGGLE,ACCELEROMETER_X,ACCELEROMETER_Y,ACCELEROMETER_Z,TILT_X,TILT_Y,GEOLOCATION_LATITUDE,GEOLOCATION_LONGITUDE,GEOLOCATION_DISTANCE,COMPASS_HEADING,RANDOM,BROWNIAN,RAMP],UI_CONTROLS=[SLIDER,TOGGLE,BUTTON];function BrownianControls(){function a(){d=setInterval(function(){var a=b[BROWNIAN_MAX_STEP_SIZE].getValue(),a=2*a*Math.random()-a,a=c.brownianControl.getValue()+a,a=Math.min(Math.max(a,0),1);c.brownianControl.update(a)},b[BROWNIAN_FREQUENCY].getValue())}var c=this,b={};b[BROWNIAN_FREQUENCY]=new Parameter(BROWNIAN_FREQUENCY,100);b[BROWNIAN_FREQUENCY].addObserver(this);b[BROWNIAN_MAX_STEP_SIZE]=new Parameter(BROWNIAN_MAX_STEP_SIZE,.1);b[BROWNIAN_MAX_STEP_SIZE].addObserver(this);this.brownianControl=
new Control(BROWNIAN,AUTO_CONTROL,b);this.brownianControl.update(.5);var d;a();this.getParameter=function(a){return b[a]};this.observedParameterChanged=function(b){b.getName()==BROWNIAN_FREQUENCY&&(clearInterval(d),a())}};function RampControls(){function a(){g=setInterval(function(){var a=1/b.duration*b.frequency;e||(a*=-1);d+=a;0<d&&1>d?b.linearRampControl.update(d):1<=d?(b.linearRampControl.update(1),c()):0>=d&&(b.linearRampControl.update(0),c())},b.frequency)}function c(){clearInterval(g);g=void 0;e=!e}var b=this;this.frequency=100;this.duration=1E4;var d=0,e=!0,f={};f[RAMP_TRIGGER]=new Parameter(RAMP_TRIGGER,0);f[RAMP_TRIGGER].addObserver(this);this.linearRampControl=new Control(RAMP,AUTO_CONTROL,f);var g;this.getParameter=
function(a){return f[a]};this.observedParameterChanged=function(b){b.getName()==RAMP_TRIGGER&&(g?c():a())}};function StatsControls(){function a(){d=setInterval(function(){c.randomControl.update(Math.random())},b[STATS_FREQUENCY].getValue())}var c=this,b={};b[STATS_FREQUENCY]=new Parameter(STATS_FREQUENCY,300);b[STATS_FREQUENCY].addObserver(this);this.randomControl=new Control(RANDOM,AUTO_CONTROL,b);var d;a();this.getParameter=function(a){return b[a]};this.observedParameterChanged=function(b){b.getName()==STATS_FREQUENCY&&(clearInterval(d),a())}};function UIControl(a,c){var b=this;this.value=a.getValue();a.setUpdateFunction(function(a){b.value=a;c&&setTimeout(function(){c.$apply()},10)});this.getName=function(){return a.getName()};this.getType=function(){return a.getType()};this.update=function(){a.getType()==BUTTON&&(this.value=1-this.value);1==this.value?a.update(1):0==this.value?a.update(0):a.update(this.value)}};function Control(a,c,b){function d(a,b){if(void 0==f||1E-6<Math.abs(a-f))f=a,e(b)}function e(a){for(var b=0;b<m.length;b++)m[b]!=a&&m[b].updateParameter(f,this)}var f,g,h,m=[],l,n,t;this.getName=function(){return a};this.getParameter=function(a){if(b)return b[a]};this.getValue=function(){return f};this.getType=function(){return c};this.getReferenceValue=function(){return g};this.setReferenceAverageCount=function(a){h=a;this.resetReferenceValue()};this.resetReferenceValue=function(){g=f=void 0;n=l=
0};this.setUpdateFunction=function(a){t=a};this.addMapping=function(a){m.push(a);a.updateParameter(f,this)};this.removeMapping=function(a){a=m.indexOf(a);-1<a&&m.splice(a,1)};this.backpropagate=function(a,b){isFinite(a)&&(d(a,b),t&&t(f))};this.update=function(a){h&&l<h?(n+=a,l++,l==h&&(g=n/=h)):isNaN(a)||(g&&(a-=g),d(a))}};function DynamicMusicObject(a,c,b){function d(a,b){b[a.getUri()]=a;for(var c=0;c<a.getParts().length;c++)d(a.getParts()[c],b)}function e(a,b,c,d){var f=a-b,g=d.getParts();if(d.getLevel()==c&&0==f)return d;if(d.getLevel()>=c-1)return f<g.length?g[f]:b+g.length;for(d=0;d<g.length;d++)if(b=e(a,b,c,g[d]),isNaN(b))return b}function f(a,b,c){var d=b.toFlatJson();a.nodes.push(d);c&&a.links.push(h(c,d));for(c=0;c<b.getParts().length;c++)f(a,b.getParts()[c],d)}function g(a,b,c){c||(c={});c[b.getUri()]||(c[b.getUri()]=
b.toFlatJson());var d=c[b.getUri()];a.nodes.push(d);for(var e=0;e<b.getSimilars().length;e++){var f=b.getSimilars()[e];c[f.getUri()]||(c[f.getUri()]=f.toFlatJson());a.links.push(h(d,c[f.getUri()]))}for(e=0;e<b.getParts().length;e++)g(a,b.getParts()[e],c)}function h(a,b){return{source:a,target:b,value:1}}var m=this,l=null,n=[],t=[],x={},q={},v=[],u=[],r;q[PLAY]=new Parameter(PLAY,0,!0);q[LOOP]=new Parameter(LOOP,0,!0);q[ONSET]=new Parameter(ONSET,-1);q[DURATION_RATIO]=new Parameter(DURATION_RATIO,
1);q[AMPLITUDE]=new Parameter(AMPLITUDE,1);q[PLAYBACK_RATE]=new Parameter(PLAYBACK_RATE,1);q[TIME_STRETCH_RATIO]=new Parameter(TIME_STRETCH_RATIO,1);q[PAN]=new Parameter(PAN,0);q[DISTANCE]=new Parameter(DISTANCE,0);q[HEIGHT]=new Parameter(HEIGHT,0);q[REVERB]=new Parameter(REVERB,0);q[FILTER]=new Parameter(FILTER,0);q[PART_INDEX]=new Parameter(PART_INDEX,0,!0);q[PART_COUNT]=new Parameter(PART_COUNT,Number.POSITIVE_INFINITY,!0);q[PLAY].addObserver(m);q[PART_INDEX].addObserver(m);q[PART_COUNT].addObserver(m);
var p=new SequentialNavigator(this);this.setType=function(a){b=a};this.getType=function(){return b};this.getUri=function(){return a};this.setParent=function(a){l=a;for(var b in q)b!=PLAY&&b!=PART_COUNT&&b!=PART_INDEX&&u.push(new Mapping([a.getParameter(b)],!0,void 0,[this],b));a=l.getMappings();var c=this.getDymoMap(),c=Object.keys(c).map(function(a){return c[a]});for(b=0;b<a.length;b++){var d=a[b].getDymoConstraint();d&&(d=a[b].getTargets().concat(c.filter(d)),a[b].setTargets(d))}};this.removeParent=
function(){for(var a=0;a<u.length;a++)u[a].disconnect();u=[];for(var b=l.getMappings(),c=this,a=0;a<b.length;a++){var d=b[a].getTargets(),d=d.filter(function(a){return!a.isSubDymoOf(c)});b[a].setTargets(d)}l=null};this.getParent=function(){return l};this.isSubDymoOf=function(a){for(var b=this;b;){if(b==a)return!0;b=b.getParent()}return!1};this.getDymoMap=function(){var a={};d(this,a);return a};this.getLevel=function(){return l?l.getLevel()+1:0};this.getIndex=function(){if(l)return l.getParts().indexOf(this)};
this.addPart=function(a){n.push(a);a.setParent(this)};this.removePart=function(a){n.splice(n.indexOf(a));a.removeParent(this)};this.replacePart=function(a,b){n[a]&&n[a].removeParent(this);n[a]=b;b.setParent(this)};this.getPart=function(a){return n[a]};this.getParts=function(){return n};this.getNthPart=function(a,b){return e(a,0,b,this)};this.setSourcePath=function(a){(r=a)&&c&&c.addSourceFile(a)};this.getSourcePath=function(){return l&&!r?l.getSourcePath():r};this.addSimilar=function(a){t.push(a)};
this.getSimilars=function(a){return t};this.getFeatures=function(){return x};this.setFeature=function(a,b){x[a]=b};this.getFeature=function(a){if(a===LEVEL)return this.getLevel();if(a===INDEX)return this.getIndex();if(x.hasOwnProperty(a))return x[a];if(l)return l.getFeature(a);for(var b=[],c=0;c<n.length;c++)if(n[c]){var d=n[c].getFeatureWithoutLookingFurther(a);isNaN(d)||b.push(d)}if(0<b.length)return b};this.getFeatureWithoutLookingFurther=function(a){if(x[a])return x[a]};this.getMappings=function(){return v};
this.getSegment=function(){return[this.getFeature("time"),q[DURATION_RATIO].getValue()*this.getFeature("duration")]};this.addParameter=function(a){q[a.getName()]=a};this.getParameter=function(a){return a==LISTENER_ORIENTATION?c.listenerOrientation:a==PART_ORDER?void 0:q[a]};this.addMapping=function(a){v.push(a)};this.observedParameterChanged=function(a){a.getName()==PLAY&&(0<a.getChange()?c.play(m):c.stop(m))};this.setNavigator=function(a){p=a};this.getNavigator=function(){return p};this.resetPartsPlayed=
function(){p.resetPartsPlayed();for(var a=0;a<n.length;a++)n[a].resetPartsPlayed()};this.updatePartOrder=function(a){n&&n[0]&&!isNaN(n[0].getFeature(a))?n.sort(function(b,c){return b.getFeature(a)-c.getFeature(a)}):n&&n.sort(function(b,c){return b.getParameter(a).getValue()-c.getParameter(a).getValue()})};this.getNextParts=function(){return p.getNextParts()};this.toJsonHierarchy=function(){for(var a=this.toFlatJson(),b=0;b<n.length;b++)a.parts.push(n[b].toJsonHierarchy());return a};this.toJsonHierarchyGraph=
function(){var a={nodes:[],links:[]};f(a,this);return a};this.toJsonSimilarityGraph=function(){var a={nodes:[],links:[]};g(a,this);return a};this.toFlatJson=function(){var c={"@id":a,"@type":DYMO};b&&(c.ct=b);r&&(c.source=r);p instanceof SimilarityNavigator&&(c.navigator=SIMILARITY_NAVIGATOR);for(var d in x)c[d]=this.getFeatureJson(d);if(0<v.length)for(c.mappings=[],d=0;d<v.length;d++)c.mappings.push(v[d].toJson());0<n.length&&(c.parts=[]);if(0<t.length)for(c.similars=[],d=0;d<t.length;d++)c.similars.push(t[d].getUri());
return c};this.getFeatureJson=function(a){return{value:x[a],type:FEATURE,adt:a.charAt(0).toUpperCase()+a.slice(1)}}};function Mapping(a,c,b,d,e,f){function g(b){for(var d=[],e=0;e<a.length;e++){var f;f="string"===typeof a[e]||a[e]instanceof String?b.getFeature(a[e]):c?a[e].getChange():a[e].getValue();d[e]=f}return m.apply(this,d)}var h=new FunctionInverter;b||(b={args:["a"],body:"return a;"});var m=Function.apply(null,b.args.concat(b.body)),l,n=h.invert(h.toReturnValueString(b.body));n&&(l=h.toJavaScriptFunction(n));this.getTargets=function(){return d};this.setTargets=function(a){d=a;for(a=0;a<d.length;a++)d[a].getParameter(e).addUpdater(this)};
this.getDymoConstraint=function(){return f};this.disconnect=function(){for(var b=0;b<a.length;b++)a[b].removeMapping?a[b].removeMapping(this):a[b].removeObserver&&a[b].removeObserver(this);for(b=0;b<d.length;b++)d[b].getParameter(e).removeUpdater(this)};this.updateParameter=function(){for(var a=0;a<d.length;a++)c?d[a].getParameter(e).relativeUpdate(g(d[a]),this):d[a].getParameter(e).update(g(d[a]),this)};this.observedParameterChanged=function(a){this.updateParameter()};this.updatedParameterChanged=
function(b){a[0].backpropagate&&!c&&(l&&(b=l(b)),a[0].backpropagate(b,this))};this.requestValue=function(b){for(var c=0;c<a.length;c++)a[c].requestValue&&a[c].requestValue();return g(b)};this.toJson=function(){for(var c=[],f=0;f<a.length;f++)a[f]instanceof Control?c.push({name:a[f].getName(),type:a[f].getType()}):a[f]instanceof Parameter?c.push({name:a[f].getName(),type:"Parameter"}):c.push({name:a[f],type:"Feature"});var c={domainDims:c,"function":b},f=d.filter(function(a){return a instanceof DynamicMusicObject}).map(function(a){return a.getUri()}),
g=d.filter(function(a){return!(a instanceof DynamicMusicObject)}).map(function(a){return a.getUri()});0<f.length&&(c.dymos=f);0<g.length&&(c.controls=g);c.parameter=e;return c};for(h=0;h<a.length;h++)a[h].addMapping?a[h].addMapping(this):a[h].addObserver&&a[h].addObserver(this);for(h=0;h<d.length;h++)d[h].getParameter(e).addUpdater(this)};function Parameter(a,c,b){function d(a,c){if(!isNaN(c)&&(b&&(c=Math.round(c)),1E-6<Math.abs(c-f))){g=c-f;f=c;for(var d=0;d<h.length;d++)h[d]!=a&&h[d].updatedParameterChanged(f);if(g)for(d=0;d<m.length;d++)m[d].observedParameterChanged(e)}}var e=this,f=c,g=0,h=[],m=[];this.getName=function(){return a};this.getValue=function(){return f};this.getChange=function(){return g};this.addUpdater=function(a){0>h.indexOf(a)&&(h.push(a),a.updatedParameterChanged(f))};this.removeUpdater=function(a){a=h.indexOf(a);
-1<a&&h.splice(a,1)};this.addObserver=function(a){m.push(a)};this.removeObserver=function(a){a=m.indexOf(a);-1<a&&m.splice(a,1)};this.getObservers=function(){return m};this.update=function(a,b){d(b,a)};this.relativeUpdate=function(a,b){this.update(f+a,b)};this.requestValue=function(){for(var a=0;a<h.length;a++){var b=h[a].requestValue();if(b&&b!=f){d(h[a],b);break}}return f}};function Rendering(a){var c=[];this.play=function(){a&&a.getParameter(PLAY).update(1)};this.stop=function(){a&&a.getParameter(PLAY).update(0)};this.addMapping=function(a){c.push(a);a.updateParameter()};this.getMappings=function(){return c};this.toJson=function(){var b={mappings:[]};a&&(b.topDymo=a.getUri());for(var d=0;d<c.length;d++)b.mappings.push(c[d].toJson());return b}};function FunctionInverter(){function a(a){if(a.isOperatorNode||a.isParenthesisNode||a.isSymbolNode)return a}function c(a){if("+"==a)return"-";if("-"==a)return"+";if("*"==a)return"/";if("/"==a)return"*"}function b(a){if("+"==a)return"add";if("-"==a)return"subtract";if("*"==a)return"multiply";if("/"==a)return"divide"}this.invert=function(d){var e;try{e=math.parse(d)}catch(h){h instanceof SyntaxError||console.log(h);return}for(var f=d=new math.expression.node.SymbolNode("a");e;)if(e.isSymbolNode)d.name=
e.name,e=void 0;else if(e.isParenthesisNode)e=e.content;else if(e.isOperatorNode){var g=c(e.op);if("+"==e.op||"*"==e.op)if(e.args[0].isConstantNode)f=new math.expression.node.OperatorNode(g,b(g),[f,e.args[0]]),e=a(e.args[1]);else if(e.args[1].isConstantNode)f=new math.expression.node.OperatorNode(g,b(g),[f,e.args[1]]),e=a(e.args[0]);else return;else if("-"==e.op||"/"==e.op)if(e.args[0].isConstantNode)f=new math.expression.node.OperatorNode(e.op,b(e.op),[e.args[0],f]),e=a(e.args[1]);else if(e.args[1].isConstantNode)f=
new math.expression.node.OperatorNode(g,b(g),[f,e.args[1]]),e=a(e.args[0]);else return}else return;return f.toString()};this.toJavaScriptFunction=function(a){return new Function("a","return "+a+";")};this.toReturnValueString=function(a){return a.substring(a.indexOf("return ")+7,a.indexOf(";"))}};function PolygonTools(){}PolygonTools.isPointInPolygon=function(a,c){for(var b=!1,d=-1,e=a.length,f=e-1;++d<e;f=d)(a[d][1]<=c[1]&&c[1]<a[f][1]||a[f][1]<=c[1]&&c[1]<a[d][1])&&c[0]<(a[f][0]-a[d][0])*(c[1]-a[d][1])/(a[f][1]-a[d][1])+a[d][0]&&(b=!b);return b};PolygonTools.getArea=function(a){var c=0,b,d,e=0;for(d=a.length-1;e<a.length;d=e,e++)b=a[e],d=a[d],c+=b[0]*d[1],c-=b[1]*d[0];return c/2};
PolygonTools.getCentroid=function(a){var c,b,d,e=0,f=0,g=0;for(b=a.length-1;g<a.length;b=g,g++)c=a[g],b=a[b],d=c[0]*b[1]-b[0]*c[1],e+=(c[0]+b[0])*d,f+=(c[1]+b[1])*d;d=6*PolygonTools.getArea(a);return{0:e/d,1:f/d}};function sqDist(a,c){return Math.pow(a[0]-c[0],2)+Math.pow(a[1]-c[1],2)}
PolygonTools.getDistanceFromSegment=function(a,c,b){var d=sqDist(c,b);if(0==d)return sqDist(a,c);d=((a[0]-c[0])*(b[0]-c[0])+(a[1]-c[1])*(b[1]-c[1]))/d;return 0>d?sqDist(a,c):1<d?sqDist(a,b):Math.sqrt(sqDist(a,{0:c[0]+d*(b[0]-c[0]),1:c[1]+d*(b[1]-c[1])}))};PolygonTools.getMinDistanceFromEdge=function(a,c){for(var b=Number.POSITIVE_INFINITY,d=0;d<a.length;d++)var e=PolygonTools.getDistanceFromSegment(c,a[d],a[(d+1)%a.length]),b=Math.min(e,b);return b};
PolygonTools.howFarIsPointInPolygon=function(a,c,b){return PolygonTools.isPointInPolygon(a,b)?(c=Math.sqrt(Math.pow(b[0]-c[0],2)+Math.pow(b[1]-c[1],2)),a=PolygonTools.getMinDistanceFromEdge(a,b),Math.sqrt((1-c)*a/Math.abs(c+a))):0};PolygonTools.getPolygonFunctionArgs=function(a){return["a","b","return PolygonTools.isPointInPolygon("+getPolygonOrPointString(a)+", {0:a, 1:b});"]};
PolygonTools.getInterpolatedPolygonFunctionArgs=function(a){var c=getPolygonOrPointString(a);a=getPolygonOrPointString(PolygonTools.getCentroid(a));return["a","b","return PolygonTools.howFarIsPointInPolygon("+c+","+a+", {0:a, 1:b});"]};function getPolygonOrPointString(a){return JSON.stringify(a).replace(/"/g,"'")};function SequentialNavigator(a){var c=!1,b=0;this.resetPartsPlayed=function(){b=0};this.setPartsPlayed=function(a){b=a};this.getPartsPlayed=function(){return b};this.getNextParts=function(){var d=a.getParts();if(0<d.length){if(a.getType()==PARALLEL){for(var e=[],f=0;f<d.length;f++){var g=d[f].getNextParts();g&&(!g.length||0<g.length)&&(e=e.concat(g))}if(0<e.length)return console.log(e.map(function(a){return a.getIndex()})),e}else for(c=!0;b<d.length&&b<a.getParameter(PART_COUNT).getValue();){if((g=
d[b].getNextParts())&&(!g.length||0<g.length))return g instanceof Array||(g=[g]),g;b++}b=0;c=!1;return null}if(c)return c=!1,null;c=!0;return[a]}};function SimilarityNavigator(a){function c(c){for(var d=0;d<c.length;d++)if(0<c[d].getSimilars().length&&Math.random()<b.leapingProbability.getValue()){var h=c[d].getSimilars(),m=Math.floor(Math.random()*h.length);if(b.continueAfterLeaping.getValue()){var l=a.getParts().indexOf(m);l&&(e=l+1)}c[d]=h[m]}}var b=this,d=!1,e=0;this.leapingProbability=new Parameter(LEAPING_PROBABILITY,.5);this.continueAfterLeaping=new Parameter(CONTINUE_AFTER_LEAPING,0,!0);this.resetPartsPlayed=function(){e=0};this.getNextParts=
function(){var b=a.getParts();if(0<b.length){if(a.getType()==PARALLEL){for(var g=[],h=0;h<b.length;h++){var m=b[h].getNextParts();m&&(!m.length||0<m.length)&&(g=g.concat(m))}if(0<g.length)return c(g),g}else for(d=!0;e<b.length&&e<a.getParameter(PART_COUNT).getValue();){if((m=b[e].getNextParts())&&(!m.length||0<m.length))return m instanceof Array||(m=[m]),c(m),m;e++}e=0;d=!1;return null}if(d)return d=!1,null;d=!0;return[a]}};function SoundTouch(a){this.rateTransposer=new RateTransposer(!1);this.tdStretch=new Stretch(!1,a);this._inputBuffer=new FifoSampleBuffer;this._intermediateBuffer=new FifoSampleBuffer;this._outputBuffer=new FifoSampleBuffer;this.tempo=this._rate=0;this.virtualTempo=this.virtualRate=this.virtualPitch=1;this._calculateEffectiveRateAndTempo()}
extend(SoundTouch.prototype,{clear:function(){this.rateTransposer.clear();this.tdStretch.clear()},clone:function(){var a=new SoundTouch;a.rate=this._rate;a.tempo=this.tempo;return a},get rate(){return this._rate},set rate(a){this.virtualRate=a;this._calculateEffectiveRateAndTempo()},set rateChange(a){this.rate=1+.01*a},get tempo(){return this._tempo},set tempo(a){this.virtualTempo=a;this._calculateEffectiveRateAndTempo()},set tempoChange(a){this.tempo=1+.01*a},set pitch(a){this.virtualPitch=a;this._calculateEffectiveRateAndTempo()},
set pitchOctaves(a){this.pitch=Math.exp(.69314718056*a);this._calculateEffectiveRateAndTempo()},set pitchSemitones(a){this.pitchOctaves=a/12},get inputBuffer(){return this._inputBuffer},get outputBuffer(){return this._outputBuffer},_calculateEffectiveRateAndTempo:function(){var a=this._tempo,c=this._rate;this._tempo=this.virtualTempo/this.virtualPitch;this._rate=this.virtualRate*this.virtualPitch;testFloatEqual(this._tempo,a)&&(this.tdStretch.tempo=this._tempo);testFloatEqual(this._rate,c)&&(this.rateTransposer.rate=
this._rate);1<this._rate?this._outputBuffer!=this.rateTransposer.outputBuffer&&(this.tdStretch.inputBuffer=this._inputBuffer,this.tdStretch.outputBuffer=this._intermediateBuffer,this.rateTransposer.inputBuffer=this._intermediateBuffer,this.rateTransposer.outputBuffer=this._outputBuffer):this._outputBuffer!=this.tdStretch.outputBuffer&&(this.rateTransposer.inputBuffer=this._inputBuffer,this.rateTransposer.outputBuffer=this._intermediateBuffer,this.tdStretch.inputBuffer=this._intermediateBuffer,this.tdStretch.outputBuffer=
this._outputBuffer)},process:function(){1<this._rate?(this.tdStretch.process(),this.rateTransposer.process()):(this.rateTransposer.process(),this.tdStretch.process())}});function FifoSampleBuffer(){this._vector=new Float32Array;this._frameCount=this._position=0}
FifoSampleBuffer.prototype={get vector(){return this._vector},get position(){return this._position},get startIndex(){return 2*this._position},get frameCount(){return this._frameCount},get endIndex(){return 2*(this._position+this._frameCount)},clear:function(){this.receive();this.rewind()},put:function(a){this._frameCount+=a},putSamples:function(a,c,b){c=2*(c||0);0<=b||(b=(a.length-c)/2);var d=2*b;this.ensureCapacity(b+this._frameCount);var e=this.endIndex;this._vector.set(a.subarray(c,c+d),e);this._frameCount+=
b},putBuffer:function(a,c,b){c=c||0;0<=b||(b=a.frameCount-c);this.putSamples(a.vector,a.position+c,b)},receive:function(a){if(!(0<=a)||a>this._frameCount)a=this._frameCount;this._frameCount-=a;this._position+=a},receiveSamples:function(a,c){var b=this.startIndex;a.set(this._vector.subarray(b,b+2*c));this.receive(c)},extract:function(a,c,b){c=this.startIndex+2*c;a.set(this._vector.subarray(c,c+2*b))},ensureCapacity:function(a){a*=2;this._vector.length<a?(a=new Float32Array(a),a.set(this._vector.subarray(this.startIndex,
this.endIndex)),this._vector=a,this._position=0):this.rewind()},ensureAdditionalCapacity:function(a){this.ensureCapacity(this.frameCount+a)},rewind:function(){0<this._position&&(this._vector.set(this._vector.subarray(this.startIndex,this.endIndex)),this._position=0)}};function extend(a,c){for(var b in c){var d=c.__lookupGetter__(b),e=c.__lookupSetter__(b);d||e?(d&&a.__defineGetter__(b,d),e&&a.__defineSetter__(b,e)):a[b]=c[b]}return a}function testFloatEqual(a,c){return 1E-10<(a>c?a-c:c-a)}
function FilterSupport(a){this._pipe=a}FilterSupport.prototype={get pipe(){return this._pipe},get inputBuffer(){return this._pipe.inputBuffer},get outputBuffer(){return this._pipe.outputBuffer},fillOutputBuffer:function(a){for(;this.outputBuffer.frameCount<a;){this.fillInputBuffer(16-this.inputBuffer.frameCount);if(16>this.inputBuffer.frameCount)break;this._pipe.process()}},clear:function(){this._pipe.clear()}};
function SimpleFilter(a,c){FilterSupport.call(this,c);this.sourceSound=a;this.historyBufferSize=22050;this._position=this.outputBufferPosition=this._sourcePosition=0}extend(SimpleFilter.prototype,FilterSupport.prototype);
extend(SimpleFilter.prototype,{get position(){return this._position},set position(a){if(a>this._position)throw new RangeError("New position may not be greater than current position");var c=this.outputBufferPosition-(this._position-a);if(0>c)throw new RangeError("New position falls outside of history buffer");this.outputBufferPosition=c;this._position=a},get sourcePosition(){return this._sourcePosition},set sourcePosition(a){this.clear();this._sourcePosition=a},fillInputBuffer:function(a){var c=new Float32Array(2*
a);a=this.sourceSound.extract(c,a,this._sourcePosition);this._sourcePosition+=a;this.inputBuffer.putSamples(c,0,a)},extract:function(a,c){this.fillOutputBuffer(this.outputBufferPosition+c);var b=Math.min(c,this.outputBuffer.frameCount-this.outputBufferPosition);this.outputBuffer.extract(a,this.outputBufferPosition,b);var d=this.outputBufferPosition+b;this.outputBufferPosition=Math.min(this.historyBufferSize,d);this.outputBuffer.receive(Math.max(d-this.historyBufferSize,0));this._position+=b;return b},
handleSampleData:function(a){this.extract(a.data,4096)},clear:function(){FilterSupport.prototype.clear.call(this);this.outputBufferPosition=0}});function AbstractFifoSamplePipe(a){a?(this.inputBuffer=new FifoSampleBuffer,this.outputBuffer=new FifoSampleBuffer):this.inputBuffer=this.outputBuffer=null}
AbstractFifoSamplePipe.prototype={get inputBuffer(){return this._inputBuffer},set inputBuffer(a){this._inputBuffer=a},get outputBuffer(){return this._outputBuffer},set outputBuffer(a){this._outputBuffer=a},clear:function(){this._inputBuffer.clear();this._outputBuffer.clear()}};function RateTransposer(a){AbstractFifoSamplePipe.call(this,a);this._reset();this.rate=1}extend(RateTransposer.prototype,AbstractFifoSamplePipe.prototype);
extend(RateTransposer.prototype,{set rate(a){this._rate=a},_reset:function(){this.prevSampleR=this.prevSampleL=this.slopeCount=0},clone:function(){var a=new RateTransposer;a.rate=this._rate;return a},process:function(){var a=this._inputBuffer.frameCount;this._outputBuffer.ensureAdditionalCapacity(a/this._rate+1);a=this._transpose(a);this._inputBuffer.receive();this._outputBuffer.put(a)},_transpose:function(a){if(0==a)return 0;for(var c=this._inputBuffer.vector,b=this._inputBuffer.startIndex,d=this._outputBuffer.vector,
e=this._outputBuffer.endIndex,f=0,g=0;1>this.slopeCount;)d[e+2*g]=(1-this.slopeCount)*this.prevSampleL+this.slopeCount*c[b],d[e+2*g+1]=(1-this.slopeCount)*this.prevSampleR+this.slopeCount*c[b+1],g++,this.slopeCount+=this._rate;--this.slopeCount;if(1!=a)a:for(;;){for(;1<this.slopeCount;)if(--this.slopeCount,f++,f>=a-1)break a;var h=b+2*f;d[e+2*g]=(1-this.slopeCount)*c[h]+this.slopeCount*c[h+2];d[e+2*g+1]=(1-this.slopeCount)*c[h+1]+this.slopeCount*c[h+3];g++;this.slopeCount+=this._rate}this.prevSampleL=
c[b+2*a-2];this.prevSampleR=c[b+2*a-1];return g}});
var USE_AUTO_SEQUENCE_LEN=0,DEFAULT_SEQUENCE_MS=USE_AUTO_SEQUENCE_LEN,USE_AUTO_SEEKWINDOW_LEN=0,DEFAULT_SEEKWINDOW_MS=USE_AUTO_SEEKWINDOW_LEN,DEFAULT_OVERLAP_MS=8,_SCAN_OFFSETS=[[124,186,248,310,372,434,496,558,620,682,744,806,868,930,992,1054,1116,1178,1240,1302,1364,1426,1488,0],[-100,-75,-50,-25,25,50,75,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-20,-15,-10,-5,5,10,15,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-4,-3,-2,-1,1,2,3,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],AUTOSEQ_TEMPO_LOW=.5,AUTOSEQ_TEMPO_TOP=2,
AUTOSEQ_AT_MIN=125,AUTOSEQ_AT_MAX=50,AUTOSEQ_K=(AUTOSEQ_AT_MAX-AUTOSEQ_AT_MIN)/(AUTOSEQ_TEMPO_TOP-AUTOSEQ_TEMPO_LOW),AUTOSEQ_C=AUTOSEQ_AT_MIN-AUTOSEQ_K*AUTOSEQ_TEMPO_LOW,AUTOSEEK_AT_MIN=25,AUTOSEEK_AT_MAX=15,AUTOSEEK_K=(AUTOSEEK_AT_MAX-AUTOSEEK_AT_MIN)/(AUTOSEQ_TEMPO_TOP-AUTOSEQ_TEMPO_LOW),AUTOSEEK_C=AUTOSEEK_AT_MIN-AUTOSEEK_K*AUTOSEQ_TEMPO_LOW;
function Stretch(a,c){AbstractFifoSamplePipe.call(this,a);this.bQuickSeek=!0;this.bMidBufferDirty=!1;this.pMidBuffer=null;this.overlapLength=0;this.bAutoSeekSetting=this.bAutoSeqSetting=!0;this._tempo=1;this.setParameters(c,DEFAULT_SEQUENCE_MS,DEFAULT_SEEKWINDOW_MS,DEFAULT_OVERLAP_MS)}extend(Stretch.prototype,AbstractFifoSamplePipe.prototype);
extend(Stretch.prototype,{clear:function(){AbstractFifoSamplePipe.prototype.clear.call(this);this._clearMidBuffer()},_clearMidBuffer:function(){this.bMidBufferDirty&&(this.bMidBufferDirty=!1,this.pMidBuffer=null)},setParameters:function(a,c,b,d){0<a&&(this.sampleRate=a);0<d&&(this.overlapMs=d);0<c?(this.sequenceMs=c,this.bAutoSeqSetting=!1):this.bAutoSeqSetting=!0;0<b?(this.seekWindowMs=b,this.bAutoSeekSetting=!1):this.bAutoSeekSetting=!0;this.calcSeqParameters();this.calculateOverlapLength(this.overlapMs);
this.tempo=this._tempo},set tempo(a){this._tempo=a;this.calcSeqParameters();this.nominalSkip=this._tempo*(this.seekWindowLength-this.overlapLength);this.skipFract=0;this.sampleReq=Math.max(Math.floor(this.nominalSkip+.5)+this.overlapLength,this.seekWindowLength)+this.seekLength},get inputChunkSize(){return this.sampleReq},get outputChunkSize(){return this.overlapLength+Math.max(0,this.seekWindowLength-2*this.overlapLength)},calculateOverlapLength:function(a){a=this.sampleRate*a/1E3;16>a&&(a=16);this.overlapLength=
a-a%8;this.pRefMidBuffer=new Float32Array(2*this.overlapLength);this.pMidBuffer=new Float32Array(2*this.overlapLength)},checkLimits:function(a,c,b){return a<c?c:a>b?b:a},calcSeqParameters:function(){var a;this.bAutoSeqSetting&&(a=AUTOSEQ_C+AUTOSEQ_K*this._tempo,a=this.checkLimits(a,AUTOSEQ_AT_MAX,AUTOSEQ_AT_MIN),this.sequenceMs=Math.floor(a+.5));this.bAutoSeekSetting&&(a=AUTOSEEK_C+AUTOSEEK_K*this._tempo,a=this.checkLimits(a,AUTOSEEK_AT_MAX,AUTOSEEK_AT_MIN),this.seekWindowMs=Math.floor(a+.5));this.seekWindowLength=
Math.floor(this.sampleRate*this.sequenceMs/1E3);this.seekLength=Math.floor(this.sampleRate*this.seekWindowMs/1E3)},set quickSeek(a){this.bQuickSeek=a},clone:function(){var a=new Stretch;a.tempo=this.tempo;a.setParameters(this.sampleRate,this.sequenceMs,this.seekWindowMs,this.overlapMs);return a},seekBestOverlapPosition:function(){return this.bQuickSeek?this.seekBestOverlapPositionStereoQuick():this.seekBestOverlapPositionStereo()},seekBestOverlapPositionStereo:function(){var a,c,b,d;this.precalcCorrReferenceStereo();
c=Number.MIN_VALUE;for(d=a=0;d<this.seekLength;d++)b=this.calcCrossCorrStereo(2*d,this.pRefMidBuffer),b>c&&(c=b,a=d);return a},seekBestOverlapPositionStereoQuick:function(){var a,c,b,d,e,f,g;this.precalcCorrReferenceStereo();b=Number.MIN_VALUE;for(e=f=c=0;4>e;e++){for(a=0;_SCAN_OFFSETS[e][a];){g=f+_SCAN_OFFSETS[e][a];if(g>=this.seekLength)break;d=this.calcCrossCorrStereo(2*g,this.pRefMidBuffer);d>b&&(b=d,c=g);a++}f=c}return c},precalcCorrReferenceStereo:function(){var a,c,b;for(a=0;a<this.overlapLength;a++)b=
a*(this.overlapLength-a),c=2*a,this.pRefMidBuffer[c]=this.pMidBuffer[c]*b,this.pRefMidBuffer[c+1]=this.pMidBuffer[c+1]*b},calcCrossCorrStereo:function(a,c){var b=this._inputBuffer.vector;a+=this._inputBuffer.startIndex;var d,e,f;d=0;for(e=2;e<2*this.overlapLength;e+=2)f=e+a,d+=b[f]*c[e]+b[f+1]*c[e+1];return d},overlap:function(a){this.overlapStereo(2*a)},overlapStereo:function(a){var c=this._inputBuffer.vector;a+=this._inputBuffer.startIndex;var b=this._outputBuffer.vector,d=this._outputBuffer.endIndex,
e,f,g,h,m,l,n;h=1/this.overlapLength;for(e=0;e<this.overlapLength;e++)g=(this.overlapLength-e)*h,m=e*h,f=2*e,l=f+a,n=f+d,b[n+0]=c[l+0]*m+this.pMidBuffer[f+0]*g,b[n+1]=c[l+1]*m+this.pMidBuffer[f+1]*g},process:function(){var a,c;if(null==this.pMidBuffer){if(this._inputBuffer.frameCount<this.overlapLength)return;this.pMidBuffer=new Float32Array(2*this.overlapLength);this._inputBuffer.receiveSamples(this.pMidBuffer,this.overlapLength)}for(;this._inputBuffer.frameCount>=this.sampleReq;)a=this.seekBestOverlapPosition(),
this._outputBuffer.ensureAdditionalCapacity(this.overlapLength),this.overlap(Math.floor(a)),this._outputBuffer.put(this.overlapLength),c=this.seekWindowLength-2*this.overlapLength,0<c&&this._outputBuffer.putBuffer(this._inputBuffer,a+this.overlapLength,c),a=this.inputBuffer.startIndex+2*(a+this.seekWindowLength-this.overlapLength),this.pMidBuffer.set(this._inputBuffer.vector.subarray(a,a+2*this.overlapLength)),this.skipFract+=this.nominalSkip,a=Math.floor(this.skipFract),this.skipFract-=a,this._inputBuffer.receive(a)}});
extend(Stretch.prototype,{get tempo(){return this._tempo}});
